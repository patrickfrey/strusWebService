<!doctype html>
<html lang="en"> 
	<head>
		<meta charset="utf-8"/>
		<title>demo client</title>

		<link rel="stylesheet" href="css/jquery-ui.css"/>
		<link rel="stylesheet" href="css/simple.css"/>
		<script src="js/jquery.js"></script>
		<script src="js/jquery-ui.js"></script>
		<script src="js/jquery.ui.waitbutton.js"></script>

		<script>
			function json2html( json ) {
				var i, ret = "";
				ret += "<ul>";
				for( i in json) {
					ret += "<li>" + i + ": <span class='" + i +"'>";
					if( typeof json[i] === "object") {
						ret += json2html( json[i] );
					} else {
						ret += json[i];
					}
					ret += "</span></li>";
				}
				ret += "</ul>";
				return ret;
			}

			function query( ) {
				var request = {
					query: {
						text: $( '#search' ).val( ),
						first_rank: 0,
						nof_ranks: 20,
						weighting: [
							// schemes
							// meta: name
							// BM25: b and k1, avgdoclen
							// weight: match
							// frequency: match
							// constant: match
							// formula: match and formula, parameters of formula
							{
								name: $( '#scheme' ).val( ),
								// TODO: make this depend on the current scheme
								params: [
									{ key: "b", value: 0.751 },
									{ key: "k1", value: 1.0001 },
									{ key: "avgdoclen", value: 11943 },
									{ key: "doclen", value: "doclen" }
								],
								weight: 0.8
							},
							{
								name: "td",
								params: [
								],
								weight: 0.2
							}
						],
						summarizer: [
							{
								attribute: "docid",
								name: "attribute",
								params: [
									{ "key" : "name",
									  "value" : "docid" }
								]
							},
							{
								attribute: "title",
								name: "attribute",
								params: [
									{ "key": "name",
									  "value" : "title" }
								]
							},
							{
								attribute: "dossier",
								name: "attribute",
								params: [
									{ "key" : "name", 
									  "value" : "dossier" }
								]
							},
							{
								attribute: "doclen",
								name: "metadata",
								params: [
									{ "key" : "name",
									  "value" : "doclen" }
								]
							},
							{
								attribute: "docweight",
								name: "metadata",
								params: [
									{ "key" : "name",
									  "value" : "docweight" }
								]
							}
//							attributes: $( "#attribute" ).val( ) || []
						]
					}
				};
				
				var html;
				var json = JSON.stringify( request, null, "    " );
				if( $( "#layout option:selected" ).val( ) == "json" ) {
					html = "<pre>" + json + "</pre>";
				} else {
					html = json2html( request );
				}
				$( '#request_data' ).html( html );
				
				$.ajax( {
					type : 'POST',
					// TODO: indexname, dynamic dropdown list
					url : '/strus/query/' + $( '#index' ).val( ),
					data : json,
					contentType : 'application/json'
				} ).done( function( data ) {
					var html;
					if( $( "#layout option:selected" ).val( ) == "json" ) {
						var json = JSON.stringify( data, null, "    " );
						html = "<pre>" + json + "</pre>";
					} else {
						html = json2html( data );
					}
					$( '#response_data' ).html( html );
				} );
			};

			function reload_weighting_parameters( ) {
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					
					var scheme = $( '#scheme' ).val( );
					var html_inputs = "";
					var html_labels = "";
					$.each( data.config.weighting_functions, function( key, value ) {
						if( value.name == scheme ) {
							$.each( value.parameter, function( key2, value2 ) {
								// TODO: get default of parameter here
								// TODO: ranges of parameters here
								// TODO: feature sets and metadata features and
								//       attributes should be three type, otherwise
								//       we cannot prepare the proper values for the
								//       the select box below
								switch( value2.type ) {
									case 'string':
										html_inputs += '<input size="10" id="weighting_param_' + value2.name + '" value=""/><br/>';
										break;
									// TODO: cannot distinguish between float and integer values here
									case 'numeric':
										html_inputs += '<input type="number" step="any" size="10" id="weighting_param_' + value2.name + '" value=""/><br/>';
										break;
									case 'feature':
										html_inputs += '<select id=weighting_param_' + value2.name + '" size="1">';
										// TODO: fill in the possible values from 'metadata', 'attributes' or 'features'
										//~ $.each( data.config.attributes, function( key, value ) {
											//~ html += "<option value='" + value + "'>" + value + "</option>"
										//~ } );
										html_inputs += '</select><br/>';
										break;
									case 'attribute':
										html_inputs += '<select id="weighting_param_' + value2.name + '" ' +
											'name=weighting_param_' + value2.name + '"' +
											' size="1">';
										html_inputs += '</select><br/>';
										$( "#weighting_param_" + value2.name ).ready( function( ) {
											reload_attributes( "weighting_param_" + value2.name );
										} );
										$( 'body' ).on( 'change', 'select.index', function( ) {
											reload_attributes( "weighting_param_" + value2.name );
										} );
										break;
									case 'metadata':
										html_inputs += '<select id="weighting_param_' + value2.name + '" ' +
											'name=weighting_param_' + value2.name + '"' +
											' size="1">';
										html_inputs += '</select><br/>';
										$( "#weighting_param_" + value2.name ).ready( function( ) {
											reload_metadata( "weighting_param_" + value2.name );
										} );
										$( 'body' ).on( 'change', 'select.index', function( ) {
											reload_metadata( "weighting_param_" + value2.name );
										} );
										break;
								}
								html_labels += '<label for="weighting_param_' + value2.name + '">' + value2.name + ':</label><br/>';
							} );
						}	
					} );

					$( '#weighting_parameters' ).html( html_inputs );
					$( '#weighting_parameters_labels' ).html( html_labels );
				} );
			}
			
			function show_weighting_info( )	{				
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					
					var scheme = $( '#scheme' ).val( );
					
					var html = "<h3>Weighting schema '" + scheme + "'</h3>";
					$.each( data.config.weighting_functions, function( key, value ) {
						if( value.name == scheme ) {
							html += "<p>" + value.description + "</p>";
						}	
					} );

					html += "<p>Parameters:</p><p><ul>"; 
					$.each( data.config.weighting_functions, function( key, value ) {
						if( value.name == scheme ) {
							$.each( value.parameter, function( key2, value2 ) {
								html += "<li>" + value2.name + ": " + value2.description + "</p>";
							} );
						}	
					} );
					html += "</ul></p>";

					$( '#weighting_info' ).html( html );					
				} );
			}

			(function($, window) {
				$.fn.replaceOptions = function(options) {
					var self, $option;

					this.empty();
					self = this;

					$.each(options, function(index, option) {
						$option = $("<option></option>")
							.attr("value", option.value)
							.text(option.text);
						self.append($option);
					});
				};
			})(jQuery, window);

			function reload_attributes( name ) {
				// get list of attributes of the current search index for presentation
				// in all dropboxes needed an attribute as parameter
				$.ajax( {
					type : 'GET',
					url : '/strus/index/config/' + $( '#index' ).val( ),
					contentType : 'application/json'
				} ).done( function( data ) {
					var options = [];
					var list = document.getElementById(name);
					$.each( data.config.attributes, function( key, v ) {
						options.push( { text: v, value: v } );
					} );
					$( "#" + name ).replaceOptions( options );

					// make sure the 'docid' attribute is always select by default
					$('#' + name + ' option[value="docid"]').attr( "selected", "selected" ).change( );
				} );
			}

			function reload_metadata( name ) {
				// get list of metadata of the current search index for presentation
				// in all dropboxes needed a metadata name as parameter
				$.ajax( {
					type : 'GET',
					url : '/strus/index/config/' + $( '#index' ).val( ),
					contentType : 'application/json'
				} ).done( function( data ) {
					var options = [];
					var list = document.getElementById(name);
					$.each( data.config.metadata, function( key, v ) {
						options.push( { text: v.name, value: v.name } );
					} );
					$( "#" + name ).replaceOptions( options );
				} );
			}
			
			function reload_summarizer_parameters( ) {
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					
					var scheme = $( '#summarizer' ).val( );
					var html_inputs = "";
					var html_labels = "";
					$.each( data.config.summarizer_functions, function( key, value ) {
						if( value.name == scheme ) {
							$.each( value.parameter, function( key2, value2 ) {
								// TODO: get default of parameter here
								// TODO: ranges of parameters here
								// TODO: feature sets and metadata features and
								//       attributes should be three type, otherwise
								//       we cannot prepare the proper values for the
								//       the select box below
								switch( value2.type ) {
									case 'string':
										html_inputs += '<input size="10" id="summarizer_param_' + value2.name + '" value=""/><br/>';
										break;
									// TODO: cannot distinguish between float and integer values here
									case 'numeric':
										html_inputs += '<input type="number" step="any" size="10" id="summarizer_param_' + value2.name + '" value=""/><br/>';
										break;
									case 'feature':
										html_inputs += '<select id="summarizer_param_' + value2.name + '" size="1">';
										// TODO: fill in the possible values from 'metadata', 'attributes' or 'features'
										//~ $.each( data.config.attributes, function( key, value ) {
											//~ html += "<option value='" + value + "'>" + value + "</option>"
										//~ } );
										html_inputs += '</select><br/>';
										break;
									case 'attribute':
										html_inputs += '<select id="summarizer_param_' + value2.name + '" ' +
											'name=summarizer_param_' + value2.name + '"' +
											' size="1">';
										html_inputs += '</select><br/>';
										$( "#summarizer_param_" + value2.name ).ready( function( ) {
											reload_attributes( "summarizer_param_" + value2.name );
										} );
										$( 'body' ).on( 'change', 'select.index', function( ) {
											reload_attributes( "summarizer_param_" + value2.name );
										} );
										break;
									case 'metadata':
										html_inputs += '<select id="summarizer_param_' + value2.name + '" ' +
											'name=summarizer_param_' + value2.name + '"' +
											' size="1">';
										html_inputs += '</select><br/>';
										$( "#summarizer_param_" + value2.name ).ready( function( ) {
											reload_metadata( "summarizer_param_" + value2.name );
										} );
										$( 'body' ).on( 'change', 'select.index', function( ) {
											reload_metadata( "summarizer_param_" + value2.name );
										} );
										break;
								}
								html_labels += '<label for="summarizer_param_' + value2.name + '">' + value2.name + ':</label><br/>';
							} );
						}	
					} );

					$( '#summarizer_parameters' ).html( html_inputs );
					$( '#summarizer_parameters_labels' ).html( html_labels );

				} );
			}

			function show_summarizer_info( )	{				
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					
					var summarizer = $( '#summarizer' ).val( );
					
					var html = "<h3>Summarizer '" + summarizer + "'</h3>";
					$.each( data.config.summarizer_functions, function( key, value ) {
						if( value.name == summarizer ) {
							html += "<p>" + value.description + "</p>";
						}	
					} );

					html += "<p>Parameters:</p><p><ul>"; 
					$.each( data.config.summarizer_functions, function( key, value ) {
						if( value.name == summarizer ) {
							$.each( value.parameter, function( key2, value2 ) {
								html += "<li>" + value2.name + ": " + value2.description + "</p>";
							} );
						}	
					} );
					html += "</ul></p>";

					$( '#summarizer_info' ).html( html );					
				} );
			}
			
			$( window ).load( function( ) {				
				// introspect the configuration for weighting functions
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					html = '<select id="scheme" class="scheme" name="scheme" size="1">';
					// TODO: fix name in service!
					$.each( data.config.weighting_functions, function( key, value ) {
						html += "<option>" + value.name + "</option>";
					} );
					html += '</select>';
					$( '#schemes' ).html( html );
					show_weighting_info( );	
					reload_weighting_parameters( );				
				} );

				// introspect the configuration for summarizer functions
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					html = '<select id="summarizer" class="summarizer" name="summarizer" size="1">';
					$.each( data.config.summarizer_functions, function( key, value ) {
						html += "<option>" + value.name + "</option>";
					} );
					html += '</select>';
					$( '#summarizers' ).html( html );
					show_summarizer_info( );
					reload_summarizer_parameters( );
				} );

				// redo the query when changing the schema
				$( 'body' ).on( 'change', 'select.scheme', function( ) {
					query( );
					show_weighting_info( );
					reload_weighting_parameters( );
				} );

				// redo the query when changing the schema
				$( 'body' ).on( 'change', 'select.summarizer', function( ) {
					query( );
					show_summarizer_info( );
					reload_summarizer_parameters( );
				} );

				// introspect service for list of all search indexes
				$.ajax( {
					type : 'GET',
					url : '/strus/index/list',
					contentType : 'application/json'
				} ).done( function( data ) {
					html = '<select id="index" class="index" name="index" size="1">';
					$.each( data.indexes, function( key, value ) {
						html += "<option>" + value + "</option>"
					} );
					html += '</select>';
					$( '#indexes' ).html( html );
				} );

				// redo the query when changing the index
				$( 'body' ).on( 'change', 'select.index', function( ) {
					query( );
				} );

				// redo the query when changing the index
				$( 'body' ).on( 'change', 'select.attribute', function( ) {
					query( );					
				} );
								
				// execute query on new characters
				$( '#search' ).keyup( function( ) {
					query( );
				} );	
				
				// change layout (rexecute query)
				$( 'body' ).on( 'change', 'select.layout', function( ) {
					query( );
				} );
			} );
		</script>      
	</head>

	<body>		
		<section>
			<div id="form">
		<form role="form">			
			<fieldset>
				<div class="labels">
				  <label for="indexes">Search index:</label><br>
				  <label for="schemes">Weighting schema:</label><br>
				  <div id="weighting_parameters_labels"></div>
				  <label for="summarizers">Summarizer function:</label><br>
				  <div id="summarizer_parameters_labels"></div>
				  <label for="layout">layout of ranklist:</label><br>
				  <label for="search">Search terms:</label><br>
				</div>
				<div class="inputs">
					<div id="indexes"></div>
					<div id="schemes"></div>
					<div id="weighting_parameters"></div>
					<div id="summarizers"></div>
					<div id="summarizer_parameters"></div>
					<div id="layouts">
						<select id="layout" name="layout" class="layout" size="1">
							<option value="json">raw JSON</option>
							<option value="list">list</option>
						</select>
					</div>
  				    <input required autocomplete='off' class="form-control input-lg" id="search" placeholder="Enter query terms ....">
				</div>
				<div id="weighting_info">
					loading..
				</div>
				<div id="summarizer_info">
					loading..
				</div>
			</div>
			</fieldset>
		</form>

		<div id="request">
		Request:
			<div id="request_data">loading...</div>
		</div>
		<div id="response">
		Response:
		<div id="response_data">loading...</div>
		</div>
		</section>
	</body>
</html>
