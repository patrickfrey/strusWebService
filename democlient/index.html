<!doctype html>
<html lang="en"> 
	<head>
		<meta charset="utf-8"/>
		<title>demo client</title>

		<link rel="stylesheet" href="css/jquery-ui.css"/>
		<link rel="stylesheet" href="css/simple.css"/>
		<script src="js/jquery.js"></script>
		<script src="js/jquery-ui.js"></script>
		<script src="js/jquery.ui.waitbutton.js"></script>

		<script>
			function json2html( json ) {
				var i, ret = "";
				ret += "<ul>";
				for( i in json) {
					ret += "<li>" + i + ": <span class='" + i +"'>";
					if( typeof json[i] === "object") {
						ret += json2html( json[i] );
					} else {
						ret += json[i];
					}
					ret += "</span></li>";
				}
				ret += "</ul>";
				return ret;
			}

			function query( ) {
				var request = {
					query: {
						text: $( '#search' ).val( ),
						first_rank: 0,
						nof_ranks: 20,
						weighting: {
							// schemes
							// meta: name
							// BM25: b and k1, avgdoclen
							// weight: match
							// frequency: match
							// constant: match
							// formula: match and formula, parameters of formula
							scheme: {
								name: $( '#scheme' ).val( ),
								// TODO: make this depend on the current scheme
								params: [
									//~ { key: "b", value: 0.75 },
									//~ { key: "k1", value: 1.0001 },
									//~ { key: "avgdoclen", value: 11943 }
								]
							}		
						},
						summarizer: {
							attributes: $( "#attribute" ).val( ) || []
						}
					}
				};
				
				var html;
				var json = JSON.stringify( request, null, "    " );
				if( $( "#layout option:selected" ).val( ) == "json" ) {
					html = "<pre>" + json + "</pre>";
				} else {
					html = json2html( request );
				}
				$( '#request_data' ).html( html );
				
				$.ajax( {
					type : 'POST',
					// TODO: indexname, dynamic dropdown list
					url : '/strus/query/' + $( '#index' ).val( ),
					data : json,
					contentType : 'application/json'
				} ).done( function( data ) {
					var html;
					if( $( "#layout option:selected" ).val( ) == "json" ) {
						var json = JSON.stringify( data, null, "    " );
						html = "<pre>" + json + "</pre>";
					} else {
						html = json2html( data );
					}
					$( '#response_data' ).html( html );
				} );
			};

			function reload_attributes( ) {
				// get list of attributes of the current search index for presentation
				// in the attribute summarizer
				$.ajax( {
					type : 'GET',
					url : '/strus/index/config/' + $( '#index' ).val( ),
					contentType : 'application/json'
				} ).done( function( data ) {
					html = '<select multiple id="attribute" class="attribute" name="attribute" size="3">';
					$.each( data.config.attributes, function( key, value ) {
						html += "<option value='" + value + "'>" + value + "</option>"
					} );
					html += '</select>';
					$( '#attributes' ).html( html );

					// make sure the 'docid' attribute is always select by default
					$('#attribute option[value="docid"]').attr( "selected", "selected" ).change( );
				} );
			};

			function reload_weighting_parameters( ) {
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					
					var scheme = $( '#scheme' ).val( );
					var html_inputs = "";
					var html_labels = "";
					$.each( data.config.weighting_funtions, function( key, value ) {
						if( value.name == scheme ) {
							$.each( value.parameter, function( key2, value2 ) {
								// TODO: get default of parameter here
								// TODO: depending on the type of the parameter provide
								// a text/numeric box, add validators or put a picker
								// combobox for names of feature sets
								html_inputs += '<input size="10" id="weighting_param_' + value2 + '" value=""/><br/>';
								html_labels += '<label for="weighting_param_' + value2 + '">' + value2 + ':</label><br/>';
							} );
						}	
					} );

					$( '#weighting_parameters' ).html( html_inputs );
					$( '#weighting_parameters_labels' ).html( html_labels );
				} );
			}
			
			function show_weighting_info( )	{				
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					
					var scheme = $( '#scheme' ).val( );
					var html = "";
					
					$.each( data.config.weighting_funtions, function( key, value ) {
						if( value.name == scheme ) {
							html = "<p>" + value.description + "</p>";
						}	
					} );

					html += "<p>Parameters:</p><p><ul>"; 
					$.each( data.config.weighting_funtions, function( key, value ) {
						if( value.name == scheme ) {
							$.each( value.parameter, function( key2, value2 ) {
								html += "<li>" + value2 + "</p>";
							} );
						}	
					} );
					html += "</ul></p>";

					$( '#info' ).html( html );					
				} );
			}
			
			$( window ).load( function( ) {				
				// introspect the configuration for weighting functions
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					html = '<select id="scheme" class="scheme" name="scheme" size="1">';
					// TODO: fix name in service!
					$.each( data.config.weighting_funtions, function( key, value ) {
						html += "<option>" + value.name + "</option>";
					} );
					html += '</select>';
					$( '#schemes' ).html( html );
					show_weighting_info( );	
					reload_weighting_parameters( );				
				} );

				// introspect the configuration for summarizer functions
				$.ajax( {
					type : 'GET',
					url : '/strus/config',
					contentType : 'application/json'
				} ).done( function( data ) {
					html = '<select id="summarizer" class="summarizer" name="summarizer" size="1">';
					$.each( data.config.summarizer_functions, function( key, value ) {
						html += "<option>" + value.name + "</option>";
					} );
					html += '</select>';
					$( '#summarizer' ).html( html );
					//~ show_summarizer_info( );	
					//~ reload_weighting_parameters( );				
				} );

				// redo the query when changing the schema
				$( 'body' ).on( 'change', 'select.scheme', function( ) {
					query( );
					show_weighting_info( );
					reload_weighting_parameters( );
				} );

				// introspect service for list of all search indexes
				$.ajax( {
					type : 'GET',
					url : '/strus/index/list',
					contentType : 'application/json'
				} ).done( function( data ) {
					html = '<select id="index" class="index" name="index" size="1">';
					$.each( data.indexes, function( key, value ) {
						html += "<option>" + value + "</option>"
					} );
					html += '</select>';
					$( '#indexes' ).html( html );
					// select first index (so that attributes get filled in)
					reload_attributes( );
				} );

				// redo the query when changing the index
				$( 'body' ).on( 'change', 'select.index', function( ) {
					query( );
					reload_attributes( );
				} );

				// redo the query when changing the index
				$( 'body' ).on( 'change', 'select.attribute', function( ) {
					query( );					
				} );
								
				// execute query on new characters
				$( '#search' ).keyup( function( ) {
					query( );
				} );	
				
				// change layout (rexecute query)
				$( 'body' ).on( 'change', 'select.layout', function( ) {
					query( );
				} );
			} );
		</script>      
	</head>

	<body>		
		<section>
			<div id="form">
		<form role="form">			
			<fieldset>
				<div class="labels">
				  <label for="indexes">Search index:</label><br>
				  <label for="schemes">Weighting schema:</label><br>
				  <div id="weighting_parameters_labels"></div>
				  <label for="summarizer">Summarizer function:</label><br>
				  <label for="attributes">Attributes for ranklist:</label><br>
				  <label for="layout">layout of ranklist:</label><br>
				  <label for="search">Search terms:</label><br>
				</div>
				<div class="inputs">
					<div id="indexes"></div>
					<div id="schemes"></div>
					<div id="weighting_parameters"></div>
					<div id="summarizer"></div>
					<div id="attributes"></div>
					<div id="layouts">
						<select id="layout" name="layout" class="layout" size="1">
							<option value="json">raw JSON</option>
							<option value="list">list</option>
						</select>
					</div>
  				    <input required autocomplete='off' class="form-control input-lg" id="search" placeholder="Enter query terms ....">
				</div>
				<div id="info">
					loading..
				</div>
			</div>
			</fieldset>
		</form>

		<div id="request">
		Request:
			<div id="request_data">loading...</div>
		</div>
		<div id="response">
		Response:
		<div id="response_data">loading...</div>
		</div>
		</section>
	</body>
</html>
